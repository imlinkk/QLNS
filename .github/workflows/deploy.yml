name: Deploy to Production

on:
  push:
    branches:
      - main # Ch·ªâ deploy khi push v√†o main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to hrm.imlink.id.vn
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "7.4"
          extensions: pdo, pdo_mysql, mbstring
          coverage: none

      - name: Validate PHP Syntax
        run: |
          echo "Checking PHP files..."
          ERROR_COUNT=0
          for file in $(find backend -name "*.php"); do
            if ! php -l "$file" > /dev/null 2>&1; then
              echo "Error in: $file"
              php -l "$file"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "Found $ERROR_COUNT PHP syntax errors!"
            exit 1
          fi
          echo "All PHP files are valid!"

      - name: Prepare Files
        run: |
          mkdir deploy

          # Copy EVERYTHING except .git and .github
          rsync -av --exclude='.git' --exclude='.github' --exclude='deploy' ./ deploy/

          # Create/update root .htaccess for the entire site
          cat > deploy/.htaccess << 'EOF'
          # Force HTTPS
          RewriteEngine On
          RewriteCond %{HTTPS} off
          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

          # SPA routing - redirect all non-file/non-dir requests to index.html
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteCond %{REQUEST_URI} !^/backend/
          RewriteRule ^(.*)$ index.html [L,QSA]

          # Disable directory listing
          Options -Indexes

          # Prevent access to sensitive files
          <FilesMatch "\.(sql|md|lock|log|ini|git|gitignore)$">
              Require all denied
          </FilesMatch>
          EOF

          echo "‚úÖ Root .htaccess created"

          # Remove unnecessary folders and files
          echo "üóëÔ∏è  Removing development/docs folders..."
          rm -rf deploy/tests
          rm -rf deploy/docs
          rm -rf deploy/CICDHow
          rm -rf deploy/setup
          rm -rf deploy/archive
          rm -rf deploy/.git
          rm -rf deploy/.github
          rm -f deploy/.gitignore
          rm -f deploy/README.md

          echo "‚úÖ All files prepared for deployment"

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          port: 21
          local-dir: ./deploy/
          server-dir: ./
          dangerous-clean-slate: false
          state-name: .ftp-deploy-sync-state.json
          # C√°c file n√†y s·∫Ω b·ªã x√≥a tr√™n server n·∫øu kh√¥ng c√≥ trong local
          # FTP-Deploy-Action s·∫Ω t·ª± ƒë·ªông:
          # - Upload file m·ªõi
          # - C·∫≠p nh·∫≠t file ƒë√£ s·ª≠a
          # - X√≥a file ƒë√£ b·ªã x√≥a ·ªü local (d·ª±a v√†o state file)
          dry-run: false

      - name: Deployment Success
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "üåê Site: https://hrm.imlink.id.vn"

      - name: Deployment Failed
        if: failure()
        run: echo "‚ùå Deployment failed! Check logs above."
