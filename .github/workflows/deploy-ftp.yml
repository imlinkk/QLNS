name: ğŸš€ Deploy to Production FTPname: ğŸš€ Deploy to Production FTP



on:on:

  push:  push:

    branches:    branches:

      - main      - main

      - fixByAlex      - fixByAlex # Deploy when pushing to fixByAlex branch

  workflow_dispatch:  workflow_dispatch: # Allow manual trigger from GitHub Actions tab



jobs:jobs:

  deploy:  deploy:

    name: ğŸŒ Deploy to hrm.imlink.id.vn    name: ğŸŒ Deploy to hrm.imlink.id.vn

    runs-on: ubuntu-latest    runs-on: ubuntu-latest

    timeout-minutes: 15

    steps:

    steps:      - name: ğŸ“¥ Checkout Code

      - name: ğŸ“¥ Checkout Code        uses: actions/checkout@v4

        uses: actions/checkout@v4        with:

        with:          fetch-depth: 0 # Full git history for better deployment

          fetch-depth: 0

      - name: ğŸ”§ Setup PHP

      - name: ğŸ”§ Setup PHP        uses: shivammathur/setup-php@v2

        uses: shivammathur/setup-php@v2        with:

        with:          php-version: "7.4"

          php-version: "7.4"          extensions: pdo, pdo_mysql, mbstring

          extensions: pdo, pdo_mysql, mbstring          coverage: none

          coverage: none

      - name: âœ… Validate PHP Syntax

      - name: âœ… Validate PHP Syntax        run: |

        run: |          echo "ğŸ” Checking PHP files for syntax errors..."

          echo "ğŸ” Checking PHP files for syntax errors..."          ERROR_COUNT=0

          ERROR_COUNT=0          while IFS= read -r -d '' file; do

          while IFS= read -r -d '' file; do            if ! php -l "$file" > /dev/null 2>&1; then

            if ! php -l "$file" > /dev/null 2>&1; then              echo "âŒ Syntax error in: $file"

              echo "âŒ Syntax error in: $file"              php -l "$file"

              php -l "$file"              ERROR_COUNT=$((ERROR_COUNT + 1))

              ERROR_COUNT=$((ERROR_COUNT + 1))            else

            else              echo "âœ“ $file"

              echo "âœ“ $file"            fi

            fi          done < <(find backend -name "*.php" -print0)

          done < <(find backend -name "*.php" -print0)

          if [ $ERROR_COUNT -gt 0 ]; then

          if [ $ERROR_COUNT -gt 0 ]; then            echo "âŒ Found $ERROR_COUNT PHP file(s) with syntax errors!"

            echo "âŒ Found $ERROR_COUNT PHP file(s) with syntax errors!"            exit 1

            exit 1          fi

          fi          echo "âœ… All PHP files are valid!"

          echo "âœ… All PHP files are valid!"

      - name: ğŸ“‹ Prepare Deployment Files

      - name: ğŸ“‹ Prepare Deployment Files        run: |

        run: |          echo "ğŸ“¦ Preparing files for deployment..."

          echo "ğŸ“¦ Preparing files for deployment..."

          mkdir -p deploy          # Create deployment directory

          cp -r backend deploy/          mkdir -p deploy

          cp -r frontend deploy/

          cp -r assets deploy/          # Copy all necessary files

          cp index.html deploy/          cp -r backend deploy/

          cp .htaccess deploy/          cp -r frontend deploy/

          cp -r assets deploy/

          echo "ğŸ”§ Configuring .htaccess for production..."          cp index.html deploy/

          cat > deploy/.htaccess << 'EOF'          cp .htaccess deploy/

          RewriteEngine On

          RewriteCond %{HTTPS} off          # Create production .htaccess if needed

          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]          echo "ğŸ”§ Configuring .htaccess for production..."

          RewriteCond %{REQUEST_FILENAME} !-f          cat > deploy/.htaccess << 'EOF'

          RewriteCond %{REQUEST_FILENAME} !-d          RewriteEngine On

          RewriteCond %{REQUEST_URI} !^/backend/

          RewriteRule ^(.*)$ index.html [L,QSA]          # Redirect HTTP to HTTPS (Production)

          RewriteCond %{REQUEST_FILENAME} !-f          RewriteCond %{HTTPS} off

          RewriteCond %{REQUEST_FILENAME} !-d          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

          RewriteRule ^backend/api\.php/(.*)$ backend/api.php [L,QSA]

          Options -Indexes          # Handle frontend routing

          <FilesMatch "\.(sql|md|json|lock|log|ini)$">          RewriteCond %{REQUEST_FILENAME} !-f

              Order allow,deny          RewriteCond %{REQUEST_FILENAME} !-d

              Deny from all          RewriteCond %{REQUEST_URI} !^/backend/

          </FilesMatch>          RewriteRule ^(.*)$ index.html [L,QSA]

          EOF

          # Handle backend API requests

          echo "ğŸ§¹ Removing development files..."          RewriteCond %{REQUEST_FILENAME} !-f

          rm -rf deploy/tests deploy/docs deploy/.git deploy/.github          RewriteCond %{REQUEST_FILENAME} !-d

          rm -f deploy/FTP.md deploy/README.md deploy/index.php          RewriteRule ^backend/api\.php/(.*)$ backend/api.php [L,QSA]

          echo "âœ… Files prepared!"

          # Security: Prevent directory browsing

      - name: ğŸ“Š Display Deployment Info          Options -Indexes

        run: |

          echo "================================================"          # Protect sensitive files

          echo "ğŸš€ DEPLOYMENT INFORMATION"          <FilesMatch "\.(sql|md|json|lock|log|ini)$">

          echo "================================================"              Order allow,deny

          echo "ğŸ“… Date: $(date)"              Deny from all

          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"          </FilesMatch>

          echo "ğŸ’¾ Commit: ${{ github.sha }}"          EOF

          echo "ğŸ‘¤ Author: ${{ github.actor }}"

          echo "ğŸ“ Message: ${{ github.event.head_commit.message }}"          # Remove development files

          echo "ğŸŒ Target: hrm.imlink.id.vn"          echo "ğŸ§¹ Removing development files..."

          echo "ğŸ“‚ Files to deploy:"          rm -rf deploy/tests

          du -sh deploy/*          rm -rf deploy/docs

          echo "================================================"          rm -rf deploy/.git

          rm -rf deploy/.github

      - name: ğŸš€ Deploy to Production FTP          rm -f deploy/FTP.md

        uses: SamKirkland/FTP-Deploy-Action@v4.3.4          rm -f deploy/README.md

        with:          rm -f deploy/index.php  # Remove test file

          server: ${{ secrets.FTP_SERVER }}

          username: ${{ secrets.FTP_USERNAME }}          echo "âœ… Files prepared for deployment!"

          password: ${{ secrets.FTP_PASSWORD }}

          protocol: ftp      - name: ğŸ“Š Display Deployment Info

          port: 2222        run: |

          local-dir: ./deploy/          echo "================================================"

          server-dir: /home/cdmidkxg/domains/hrm.imlink.id.vn/public_html/          echo "ğŸš€ DEPLOYMENT INFORMATION"

          timeout: 600000          echo "================================================"

          exclude: |          echo "ğŸ“… Date: $(date)"

            **/.git*          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"

            **/.git*/**          echo "ğŸ’¾ Commit: ${{ github.sha }}"

            **/node_modules/**          echo "ğŸ‘¤ Author: ${{ github.actor }}"

            **/.DS_Store          echo "ğŸ“ Message: ${{ github.event.head_commit.message }}"

            **/tests/**          echo "ğŸŒ Target: hrm.imlink.id.vn"

            **/docs/**          echo "ğŸ“‚ Files to deploy:"

            **/*.md          du -sh deploy/*

            **/composer.json          echo "================================================"

            **/composer.lock

            **/package.json      - name: ï¿½ Test FTP Connection (Debug)

            **/package-lock.json        run: |

            **/.env.example          echo "ğŸ” Testing FTP connection..."

          echo "Server: ${{ secrets.FTP_SERVER }}"

      - name: ğŸ‰ Deployment Complete          echo "Username length: ${#FTP_USERNAME}"

        run: |          echo "First 5 chars of username: ${FTP_USERNAME:0:5}"

          echo "================================================"          

          echo "âœ… DEPLOYMENT SUCCESSFUL!"          # Install lftp for testing

          echo "================================================"          sudo apt-get update -qq

          echo "ğŸŒ Your application is now live at:"          sudo apt-get install -y lftp

          echo "   https://hrm.imlink.id.vn"          

          echo ""          # Test FTP connection

          echo "ğŸ“‹ Next steps:"          lftp -e "set ftp:ssl-allow no; open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_SERVER }}:2222; ls; bye" || echo "âŒ FTP connection failed!"

          echo "   1. Visit https://hrm.imlink.id.vn to verify"        env:

          echo "   2. Test login functionality"          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}

          echo "   3. Check all modules are working"

          echo "   4. Verify database connection"      - name: ï¿½ğŸš€ Deploy to Production FTP

          echo "================================================"        uses: SamKirkland/FTP-Deploy-Action@v4.3.4

        with:

      - name: ğŸ”” Notify on Failure          server: ${{ secrets.FTP_SERVER }}

        if: failure()          username: ${{ secrets.FTP_USERNAME }}

        run: |          password: ${{ secrets.FTP_PASSWORD }}

          echo "================================================"          protocol: ftp             # âœ… FTP thÆ°á»ng (123host khÃ´ng cáº§n SSL)

          echo "âŒ DEPLOYMENT FAILED!"          port: 2222                # âœ… Port FTP cá»§a 123host

          echo "================================================"          local-dir: ./deploy/      # ThÆ° má»¥c source Ä‘á»ƒ upload

          echo "Please check the logs above for errors."          server-dir: /home/cdmidkxg/domains/hrm.imlink.id.vn/public_html/  # âœ… ÄÆ°á»ng dáº«n Ä‘áº§y Ä‘á»§ trÃªn server

          echo "Common issues:"          exclude: |

          echo "  - FTP credentials incorrect"            **/.git*

          echo "  - Server connection timeout"            **/.git*/**

          echo "  - Insufficient permissions"            **/node_modules/**

          echo "  - Network issues"            **/.DS_Store

          echo "================================================"            **/tests/**

            **/docs/**
            **/*.md
            **/composer.json
            **/composer.lock
            **/package.json
            **/package-lock.json
            **/.env.example

      - name: ğŸ‰ Deployment Complete
        run: |
          echo "================================================"
          echo "âœ… DEPLOYMENT SUCCESSFUL!"
          echo "================================================"
          echo "ğŸŒ Your application is now live at:"
          echo "   https://hrm.imlink.id.vn"
          echo ""
          echo "ğŸ“‹ Next steps:"
          echo "   1. Visit https://hrm.imlink.id.vn to verify"
          echo "   2. Test login with: admin / admin123"
          echo "   3. Check all modules are working"
          echo "   4. Verify database connection"
          echo ""
          echo "âš ï¸  Remember to:"
          echo "   - Check database credentials in Database.php"
          echo "   - Ensure SSL certificate is active"
          echo "   - Test all CRUD operations"
          echo "================================================"

      - name: ğŸ”” Notify on Failure
        if: failure()
        run: |
          echo "================================================"
          echo "âŒ DEPLOYMENT FAILED!"
          echo "================================================"
          echo "Please check the logs above for errors."
          echo "Common issues:"
          echo "  - FTP credentials incorrect"
          echo "  - Server connection timeout"
          echo "  - Insufficient permissions"
          echo "  - Network issues"
          echo "================================================"
