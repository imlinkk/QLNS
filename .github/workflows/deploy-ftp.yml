name: üöÄ Deploy to Production FTPname: üöÄ Deploy to Production FTPname: üöÄ Deploy to Production FTP



on:

  push:

    branches:on:on:

      - main

      - fixByAlex  push:  push:

  workflow_dispatch:

    branches:    branches:

jobs:

  deploy:      - main      - main

    name: üåê Deploy to hrm.imlink.id.vn

    runs-on: ubuntu-latest      - fixByAlex      - fixByAlex # Deploy when pushing to fixByAlex branch

    timeout-minutes: 15

  workflow_dispatch:  workflow_dispatch: # Allow manual trigger from GitHub Actions tab

    steps:

      - name: üì• Checkout Code

        uses: actions/checkout@v4

        with:jobs:jobs:

          fetch-depth: 0

  deploy:  deploy:

      - name: üîß Setup PHP

        uses: shivammathur/setup-php@v2    name: üåê Deploy to hrm.imlink.id.vn    name: üåê Deploy to hrm.imlink.id.vn

        with:

          php-version: "7.4"    runs-on: ubuntu-latest    runs-on: ubuntu-latest

          extensions: pdo, pdo_mysql, mbstring

          coverage: none    timeout-minutes: 15



      - name: ‚úÖ Validate PHP Syntax    steps:

        run: |

          echo "üîç Checking PHP files for syntax errors..."    steps:      - name: üì• Checkout Code

          ERROR_COUNT=0

          while IFS= read -r -d '' file; do      - name: üì• Checkout Code        uses: actions/checkout@v4

            if ! php -l "$file" > /dev/null 2>&1; then

              echo "‚ùå Syntax error in: $file"        uses: actions/checkout@v4        with:

              php -l "$file"

              ERROR_COUNT=$((ERROR_COUNT + 1))        with:          fetch-depth: 0 # Full git history for better deployment

            else

              echo "‚úì $file"          fetch-depth: 0

            fi

          done < <(find backend -name "*.php" -print0)      - name: üîß Setup PHP



          if [ $ERROR_COUNT -gt 0 ]; then      - name: üîß Setup PHP        uses: shivammathur/setup-php@v2

            echo "‚ùå Found $ERROR_COUNT PHP file(s) with syntax errors!"

            exit 1        uses: shivammathur/setup-php@v2        with:

          fi

          echo "‚úÖ All PHP files are valid!"        with:          php-version: "7.4"



      - name: üìã Prepare Deployment Files          php-version: "7.4"          extensions: pdo, pdo_mysql, mbstring

        run: |

          echo "üì¶ Preparing files for deployment..."          extensions: pdo, pdo_mysql, mbstring          coverage: none

          mkdir -p deploy

          cp -r backend deploy/          coverage: none

          cp -r frontend deploy/

          cp -r assets deploy/      - name: ‚úÖ Validate PHP Syntax

          cp index.html deploy/

          cp .htaccess deploy/      - name: ‚úÖ Validate PHP Syntax        run: |



          echo "üîß Configuring .htaccess for production..."        run: |          echo "üîç Checking PHP files for syntax errors..."

          cat > deploy/.htaccess << 'EOF'

          RewriteEngine On          echo "üîç Checking PHP files for syntax errors..."          ERROR_COUNT=0

          RewriteCond %{HTTPS} off

          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]          ERROR_COUNT=0          while IFS= read -r -d '' file; do

          RewriteCond %{REQUEST_FILENAME} !-f

          RewriteCond %{REQUEST_FILENAME} !-d          while IFS= read -r -d '' file; do            if ! php -l "$file" > /dev/null 2>&1; then

          RewriteCond %{REQUEST_URI} !^/backend/

          RewriteRule ^(.*)$ index.html [L,QSA]            if ! php -l "$file" > /dev/null 2>&1; then              echo "‚ùå Syntax error in: $file"

          RewriteCond %{REQUEST_FILENAME} !-f

          RewriteCond %{REQUEST_FILENAME} !-d              echo "‚ùå Syntax error in: $file"              php -l "$file"

          RewriteRule ^backend/api\.php/(.*)$ backend/api.php [L,QSA]

          Options -Indexes              php -l "$file"              ERROR_COUNT=$((ERROR_COUNT + 1))

          <FilesMatch "\.(sql|md|json|lock|log|ini)$">

              Order allow,deny              ERROR_COUNT=$((ERROR_COUNT + 1))            else

              Deny from all

          </FilesMatch>            else              echo "‚úì $file"

          EOF

              echo "‚úì $file"            fi

          echo "üßπ Removing development files..."

          rm -rf deploy/tests deploy/docs deploy/.git deploy/.github            fi          done < <(find backend -name "*.php" -print0)

          rm -f deploy/FTP.md deploy/README.md deploy/index.php

          echo "‚úÖ Files prepared!"          done < <(find backend -name "*.php" -print0)



      - name: üìä Display Deployment Info          if [ $ERROR_COUNT -gt 0 ]; then

        run: |

          echo "================================================"          if [ $ERROR_COUNT -gt 0 ]; then            echo "‚ùå Found $ERROR_COUNT PHP file(s) with syntax errors!"

          echo "üöÄ DEPLOYMENT INFORMATION"

          echo "================================================"            echo "‚ùå Found $ERROR_COUNT PHP file(s) with syntax errors!"            exit 1

          echo "üìÖ Date: $(date)"

          echo "üåø Branch: ${{ github.ref_name }}"            exit 1          fi

          echo "üíæ Commit: ${{ github.sha }}"

          echo "üë§ Author: ${{ github.actor }}"          fi          echo "‚úÖ All PHP files are valid!"

          echo "üìù Message: ${{ github.event.head_commit.message }}"

          echo "üåê Target: hrm.imlink.id.vn"          echo "‚úÖ All PHP files are valid!"

          echo "üìÇ Files to deploy:"

          du -sh deploy/*      - name: üìã Prepare Deployment Files

          echo "================================================"

      - name: üìã Prepare Deployment Files        run: |

      - name: üöÄ Deploy to Production FTP

        uses: SamKirkland/FTP-Deploy-Action@v4.3.4        run: |          echo "üì¶ Preparing files for deployment..."

        with:

          server: ${{ secrets.FTP_SERVER }}          echo "üì¶ Preparing files for deployment..."

          username: ${{ secrets.FTP_USERNAME }}

          password: ${{ secrets.FTP_PASSWORD }}          mkdir -p deploy          # Create deployment directory

          protocol: ftp

          port: 2222          cp -r backend deploy/          mkdir -p deploy

          local-dir: ./deploy/

          server-dir: /home/cdmidkxg/domains/hrm.imlink.id.vn/public_html/          cp -r frontend deploy/

          timeout: 600000

          exclude: |          cp -r assets deploy/          # Copy all necessary files

            **/.git*

            **/.git*/**          cp index.html deploy/          cp -r backend deploy/

            **/node_modules/**

            **/.DS_Store          cp .htaccess deploy/          cp -r frontend deploy/

            **/tests/**

            **/docs/**          cp -r assets deploy/

            **/*.md

            **/composer.json          echo "üîß Configuring .htaccess for production..."          cp index.html deploy/

            **/composer.lock

            **/package.json          cat > deploy/.htaccess << 'EOF'          cp .htaccess deploy/

            **/package-lock.json

            **/.env.example          RewriteEngine On



      - name: üéâ Deployment Complete          RewriteCond %{HTTPS} off          # Create production .htaccess if needed

        run: |

          echo "================================================"          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]          echo "üîß Configuring .htaccess for production..."

          echo "‚úÖ DEPLOYMENT SUCCESSFUL!"

          echo "================================================"          RewriteCond %{REQUEST_FILENAME} !-f          cat > deploy/.htaccess << 'EOF'

          echo "üåê Your application is now live at:"

          echo "   https://hrm.imlink.id.vn"          RewriteCond %{REQUEST_FILENAME} !-d          RewriteEngine On

          echo ""

          echo "üìã Next steps:"          RewriteCond %{REQUEST_URI} !^/backend/

          echo "   1. Visit https://hrm.imlink.id.vn to verify"

          echo "   2. Test login functionality"          RewriteRule ^(.*)$ index.html [L,QSA]          # Redirect HTTP to HTTPS (Production)

          echo "   3. Check all modules are working"

          echo "   4. Verify database connection"          RewriteCond %{REQUEST_FILENAME} !-f          RewriteCond %{HTTPS} off

          echo "================================================"

          RewriteCond %{REQUEST_FILENAME} !-d          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

      - name: üîî Notify on Failure

        if: failure()          RewriteRule ^backend/api\.php/(.*)$ backend/api.php [L,QSA]

        run: |

          echo "================================================"          Options -Indexes          # Handle frontend routing

          echo "‚ùå DEPLOYMENT FAILED!"

          echo "================================================"          <FilesMatch "\.(sql|md|json|lock|log|ini)$">          RewriteCond %{REQUEST_FILENAME} !-f

          echo "Please check the logs above for errors."

          echo "Common issues:"              Order allow,deny          RewriteCond %{REQUEST_FILENAME} !-d

          echo "  - FTP credentials incorrect"

          echo "  - Server connection timeout"              Deny from all          RewriteCond %{REQUEST_URI} !^/backend/

          echo "  - Insufficient permissions"

          echo "  - Network issues"          </FilesMatch>          RewriteRule ^(.*)$ index.html [L,QSA]

          echo "================================================"

          EOF

          # Handle backend API requests

          echo "üßπ Removing development files..."          RewriteCond %{REQUEST_FILENAME} !-f

          rm -rf deploy/tests deploy/docs deploy/.git deploy/.github          RewriteCond %{REQUEST_FILENAME} !-d

          rm -f deploy/FTP.md deploy/README.md deploy/index.php          RewriteRule ^backend/api\.php/(.*)$ backend/api.php [L,QSA]

          echo "‚úÖ Files prepared!"

          # Security: Prevent directory browsing

      - name: üìä Display Deployment Info          Options -Indexes

        run: |

          echo "================================================"          # Protect sensitive files

          echo "üöÄ DEPLOYMENT INFORMATION"          <FilesMatch "\.(sql|md|json|lock|log|ini)$">

          echo "================================================"              Order allow,deny

          echo "üìÖ Date: $(date)"              Deny from all

          echo "üåø Branch: ${{ github.ref_name }}"          </FilesMatch>

          echo "üíæ Commit: ${{ github.sha }}"          EOF

          echo "üë§ Author: ${{ github.actor }}"

          echo "üìù Message: ${{ github.event.head_commit.message }}"          # Remove development files

          echo "üåê Target: hrm.imlink.id.vn"          echo "üßπ Removing development files..."

          echo "üìÇ Files to deploy:"          rm -rf deploy/tests

          du -sh deploy/*          rm -rf deploy/docs

          echo "================================================"          rm -rf deploy/.git

          rm -rf deploy/.github

      - name: üöÄ Deploy to Production FTP          rm -f deploy/FTP.md

        uses: SamKirkland/FTP-Deploy-Action@v4.3.4          rm -f deploy/README.md

        with:          rm -f deploy/index.php  # Remove test file

          server: ${{ secrets.FTP_SERVER }}

          username: ${{ secrets.FTP_USERNAME }}          echo "‚úÖ Files prepared for deployment!"

          password: ${{ secrets.FTP_PASSWORD }}

          protocol: ftp      - name: üìä Display Deployment Info

          port: 2222        run: |

          local-dir: ./deploy/          echo "================================================"

          server-dir: /home/cdmidkxg/domains/hrm.imlink.id.vn/public_html/          echo "üöÄ DEPLOYMENT INFORMATION"

          timeout: 600000          echo "================================================"

          exclude: |          echo "üìÖ Date: $(date)"

            **/.git*          echo "üåø Branch: ${{ github.ref_name }}"

            **/.git*/**          echo "üíæ Commit: ${{ github.sha }}"

            **/node_modules/**          echo "üë§ Author: ${{ github.actor }}"

            **/.DS_Store          echo "üìù Message: ${{ github.event.head_commit.message }}"

            **/tests/**          echo "üåê Target: hrm.imlink.id.vn"

            **/docs/**          echo "üìÇ Files to deploy:"

            **/*.md          du -sh deploy/*

            **/composer.json          echo "================================================"

            **/composer.lock

            **/package.json      - name: ÔøΩ Test FTP Connection (Debug)

            **/package-lock.json        run: |

            **/.env.example          echo "üîç Testing FTP connection..."

          echo "Server: ${{ secrets.FTP_SERVER }}"

      - name: üéâ Deployment Complete          echo "Username length: ${#FTP_USERNAME}"

        run: |          echo "First 5 chars of username: ${FTP_USERNAME:0:5}"

          echo "================================================"          

          echo "‚úÖ DEPLOYMENT SUCCESSFUL!"          # Install lftp for testing

          echo "================================================"          sudo apt-get update -qq

          echo "üåê Your application is now live at:"          sudo apt-get install -y lftp

          echo "   https://hrm.imlink.id.vn"          

          echo ""          # Test FTP connection

          echo "üìã Next steps:"          lftp -e "set ftp:ssl-allow no; open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_SERVER }}:2222; ls; bye" || echo "‚ùå FTP connection failed!"

          echo "   1. Visit https://hrm.imlink.id.vn to verify"        env:

          echo "   2. Test login functionality"          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}

          echo "   3. Check all modules are working"

          echo "   4. Verify database connection"      - name: ÔøΩüöÄ Deploy to Production FTP

          echo "================================================"        uses: SamKirkland/FTP-Deploy-Action@v4.3.4

        with:

      - name: üîî Notify on Failure          server: ${{ secrets.FTP_SERVER }}

        if: failure()          username: ${{ secrets.FTP_USERNAME }}

        run: |          password: ${{ secrets.FTP_PASSWORD }}

          echo "================================================"          protocol: ftp             # ‚úÖ FTP th∆∞·ªùng (123host kh√¥ng c·∫ßn SSL)

          echo "‚ùå DEPLOYMENT FAILED!"          port: 2222                # ‚úÖ Port FTP c·ªßa 123host

          echo "================================================"          local-dir: ./deploy/      # Th∆∞ m·ª•c source ƒë·ªÉ upload

          echo "Please check the logs above for errors."          server-dir: /home/cdmidkxg/domains/hrm.imlink.id.vn/public_html/  # ‚úÖ ƒê∆∞·ªùng d·∫´n ƒë·∫ßy ƒë·ªß tr√™n server

          echo "Common issues:"          exclude: |

          echo "  - FTP credentials incorrect"            **/.git*

          echo "  - Server connection timeout"            **/.git*/**

          echo "  - Insufficient permissions"            **/node_modules/**

          echo "  - Network issues"            **/.DS_Store

          echo "================================================"            **/tests/**

            **/docs/**
            **/*.md
            **/composer.json
            **/composer.lock
            **/package.json
            **/package-lock.json
            **/.env.example

      - name: üéâ Deployment Complete
        run: |
          echo "================================================"
          echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
          echo "================================================"
          echo "üåê Your application is now live at:"
          echo "   https://hrm.imlink.id.vn"
          echo ""
          echo "üìã Next steps:"
          echo "   1. Visit https://hrm.imlink.id.vn to verify"
          echo "   2. Test login with: admin / admin123"
          echo "   3. Check all modules are working"
          echo "   4. Verify database connection"
          echo ""
          echo "‚ö†Ô∏è  Remember to:"
          echo "   - Check database credentials in Database.php"
          echo "   - Ensure SSL certificate is active"
          echo "   - Test all CRUD operations"
          echo "================================================"

      - name: üîî Notify on Failure
        if: failure()
        run: |
          echo "================================================"
          echo "‚ùå DEPLOYMENT FAILED!"
          echo "================================================"
          echo "Please check the logs above for errors."
          echo "Common issues:"
          echo "  - FTP credentials incorrect"
          echo "  - Server connection timeout"
          echo "  - Insufficient permissions"
          echo "  - Network issues"
          echo "================================================"
