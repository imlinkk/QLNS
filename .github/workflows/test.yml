name: CI/CD Test (No Deploy)

on:
  push:
    branches:
      - develop
      - fixByAlex
      - "feature/**"
      - "bugfix/**"
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  test:
    name: Test & Validate Code
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "7.4"
          extensions: pdo, pdo_mysql, mbstring
          coverage: none

      - name: Validate PHP Syntax
        run: |
          echo "üîç Checking PHP files for syntax errors..."
          ERROR_COUNT=0

          if [ -d "backend" ]; then
            for file in $(find backend -name "*.php"); do
              if ! php -l "$file" > /dev/null 2>&1; then
                echo "‚ùå Error in: $file"
                php -l "$file"
                ERROR_COUNT=$((ERROR_COUNT + 1))
              else
                echo "‚úÖ $file"
              fi
            done
          fi

          if [ $ERROR_COUNT -gt 0 ]; then
            echo ""
            echo "‚ùå Found $ERROR_COUNT PHP syntax errors!"
            exit 1
          fi

          echo ""
          echo "‚úÖ All PHP files are valid!"

      - name: Check File Structure
        run: |
          echo "üìÅ Checking project structure..."

          # Check required directories
          REQUIRED_DIRS=("backend" "frontend" "assets")
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              echo "‚úÖ $dir/ exists"
            else
              echo "‚ö†Ô∏è  $dir/ not found"
            fi
          done

          # Check required files
          REQUIRED_FILES=("index.html" "backend/api.php" "backend/autoload.php")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file exists"
            else
              echo "‚ùå $file not found"
              exit 1
            fi
          done

      - name: Check PSR-4 Folder Names
        run: |
          echo "üîç Verifying PSR-4 folder naming..."

          # Check if folders follow PSR-4 (PascalCase)
          BACKEND_FOLDERS=("Core" "Config" "Controllers" "Models" "Routes")
          ALL_GOOD=true

          for folder in "${BACKEND_FOLDERS[@]}"; do
            if [ -d "backend/$folder" ]; then
              echo "‚úÖ backend/$folder/ (correct)"
            else
              echo "‚ùå backend/$folder/ not found (PSR-4 violation)"
              ALL_GOOD=false
            fi
          done

          if [ "$ALL_GOOD" = false ]; then
            echo ""
            echo "‚ö†Ô∏è  Warning: Some PSR-4 folders are missing or incorrectly named"
            echo "   Folders should be PascalCase: Core, Config, Controllers, Models, Routes"
          else
            echo ""
            echo "‚úÖ All PSR-4 folders are correctly named!"
          fi

      - name: Test Summary
        if: success()
        run: |
          echo ""
          echo "======================================"
          echo "‚úÖ All tests passed!"
          echo "======================================"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo ""
          echo "‚ÑπÔ∏è  Note: This is a test run only."
          echo "   To deploy to production, merge to 'main' branch."
          echo "======================================"

      - name: Test Failed
        if: failure()
        run: |
          echo ""
          echo "======================================"
          echo "‚ùå Tests failed!"
          echo "======================================"
          echo "Please fix the errors above before merging."
          echo "======================================"
